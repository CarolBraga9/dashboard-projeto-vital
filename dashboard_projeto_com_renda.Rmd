---
title: "Dashboard do Projeto"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: yeti
    iconLib: font-awesome
    encoding: UTF-8
runtime: shiny
---

```{r setup, include=FALSE}
# --- Dependências e Configurações Iniciais ---

# Instalação de pacotes necessários para o dashboard
packages <- c("flexdashboard", "shiny", "shinyjs", "dplyr", "leaflet", "sf", 
              "geobr", "htmlwidgets", "viridis", "timevis", "lubridate", 
              "DT", "googlesheets4", "purrr")

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    # A URL do repositório deve ser uma string de texto simples
    install.packages(pkg, repos = "https://cloud.r-project.org")
    library(pkg, character.only = TRUE)
  }
}

# Define o locale para Português do Brasil para formatação correta
try(Sys.setlocale("LC_ALL", "pt_BR.UTF-8"), silent = TRUE)

# --- Carregamento e Preparação dos Dados (Não-Reativo) ---

# Autenticação desabilitada para acesso a planilhas públicas do Google Sheets
gs4_deauth()
# A URL da planilha deve ser uma string de texto simples
url_planilha <- "https://docs.google.com/spreadsheets/d/1NUxmO-_XYut_3AwsdM9uMo9d9bFTHC47JYONnfbYsw8/edit?usp=sharing"

# Leitura das abas da planilha
profissionais <- read_sheet(url_planilha, sheet = "treinamento")
atendimentos <- read_sheet(url_planilha, sheet = "atendimentos")
geo <- read_sheet(url_planilha, sheet = "geo")
translations_df <- read_sheet(url_planilha, sheet = "traducao")

# --- Processamento Geográfico ---

# Define o sistema de referência de coordenadas (CRS) para SIRGAS 2000
crs_sirgas2000 <- 4674 
geo <- geo %>% filter(!grepl("S", POSTCODE)) # Filtra códigos postais inválidos
geo$geolocation_zip_code_prefix <- as.numeric(substr(geo$POSTCODE, 1, 5))

# Converte o data.frame para um objeto espacial (sf)
geo_sf <- st_as_sf(geo, coords = c("LON", "LAT"), crs = 4326)

# Carrega o shapefile do município de São Paulo e converte o CRS
sp_city <- read_municipality(code_muni = 3550308, year = 2020) %>% 
  st_transform(crs = crs_sirgas2000)

# Transforma o CRS dos dados geográficos para corresponder ao do município
geo_sf <- st_transform(geo_sf, crs = crs_sirgas2000)

# Filtra apenas os pontos que estão dentro dos limites de São Paulo
sp_only <- geo_sf[st_within(geo_sf, sp_city, sparse = FALSE), ]

# --- Indicadores Chave ---

num_treinados <- sum(profissionais$treinamento_realizado == "Sim", na.rm = TRUE)
nota_media <- mean(profissionais$nota_avaliacao, na.rm = TRUE)
total_atendidos <- n_distinct(atendimentos$id_pessoa)
total_atendimentos <- nrow(atendimentos)

# --- Configuração de Tradução (Apenas a estrutura de dados) ---
# A parte reativa (current_lang, tr) foi movida para o bloco context="server"

translations <- list(
  pt = setNames(as.list(translations_df$pt), translations_df$key),
  en = setNames(as.list(translations_df$en), translations_df$key)
)
```

<style>
/* Estilos personalizados para o dashboard */
.container-fluid { max-width: 98% !important; }
.logo-container {
  position: fixed;
  top: 5px;
  left: 60px; /* Ajustado para não sobrepor o título */
  z-index: 1050;
}
.logo-left { height: 40px; }
.lang-buttons { 
  position: fixed; 
  top: 10px; 
  right: 20px; 
  z-index: 1051; /* Garante que os botões fiquem acima de outros elementos */
}
.lang-buttons .btn { 
  padding: 4px 8px; 
  font-size: 12px; 
}
</style>

<div class="logo-container">
  <a href="#"><img src="https://wiconnect.iadb.org/wp-content/uploads/2023/07/64ad685333e5720230711143355-1.png" alt="Logo" class="logo-left"></a>
</div>

```{r, echo=FALSE}
# UI para os botões de seleção de idioma
uiOutput("lang_buttons_ui")
```

<script>
// JavaScript para atualizar dinamicamente o título da página e do dashboard
Shiny.addCustomMessageHandler('setDocumentTitle', function(message) {
  document.title = message.title;
  $('.navbar-brand').text(message.title);
});
</script>

Página Inicial {data-icon="fa-home"}
=====================================

### `r textOutput("welcome_title", inline = TRUE)`

`r textOutput("welcome_intro")`

Cronograma do Projeto {data-icon="fa-calendar"}
=====================================

### Cronograma de Atividades (Gantt)

```{r}
# UI para o gráfico de Gantt
timevisOutput("gantt_chart", height = "800px")
```

Outcomes {data-icon="fa-trophy"}
=====================================

Column {.value-boxes}
-------------------------------------

### Redução na Taxa de Reincidência

```{r}
# UI para o ValueBox do outcome
valueBoxOutput("outcome1_vb")
```

Tracking Indicators {data-icon="fa-chart-bar .tabset"}
=====================================

### `r textOutput("tracking_map1_title", inline = TRUE)`

```{r}
# UI para o mapa de atendimentos
leafletOutput("map_atendimentos")
```

### `r textOutput("tracking_map2_title", inline = TRUE)`

```{r}
# UI para o mapa de renda
leafletOutput("map_renda")
```{r context="server"}
# ===================================================================
# LÓGICA DO SERVIDOR SHINY
# Todo o código reativo (que usa input/output) deve estar aqui.
# ===================================================================

# --- Lógica de Tradução e UI Dinâmica ---

# Cria um valor reativo para armazenar o idioma atual.
current_lang <- reactiveVal("pt")

# Função auxiliar para buscar a tradução da chave no idioma atual.
tr <- function(key) {
  translations[[current_lang()]][[key]] %||% paste("Missing:", key)
}

# Renderiza os botões de idioma
output$lang_buttons_ui <- renderUI({
  div(class = "lang-buttons",
      actionButton("lang_pt", "PT", class = "btn btn-primary"),
      actionButton("lang_en", "EN", class = "btn btn-default")
  )
})

# Observa cliques nos botões de idioma
observeEvent(input$lang_pt, { current_lang("pt") })
observeEvent(input$lang_en, { current_lang("en") })

# Atualiza o estilo dos botões quando o idioma muda
observe({
  is_pt <- current_lang() == "pt"
  shinyjs::toggleClass(selector = "#lang_pt", class = "btn-primary", condition = is_pt)
  shinyjs::toggleClass(selector = "#lang_pt", class = "btn-default", condition = !is_pt)
  shinyjs::toggleClass(selector = "#lang_en", class = "btn-primary", condition = !is_pt)
  shinyjs::toggleClass(selector = "#lang_en", class = "btn-default", condition = is_pt)
})

# Atualiza o título do dashboard quando o idioma muda
observe({
  title <- tr("dashboard_title")
  session$sendCustomMessage(type = 'setDocumentTitle', message = list(title = title))
})


# --- Renderização dos Outputs da UI ---

# Página Inicial
output$welcome_title <- renderText({ tr("welcome_title") })
output$welcome_intro <- renderText({ tr("welcome_intro") })

# Cronograma
output$gantt_chart <- renderTimevis({
  gantt_data <- data.frame(
    id = 1:3,
    content = c(tr("planning"), tr("execution"), tr("closure")),
    start = as.Date(c("2025-01-01", "2025-05-26", "2025-12-26")),
    end = as.Date(c("2025-05-25", "2025-12-25", "2026-06-26")),
    className = c("completed", "not-started", "not-started")
  )
  timevis(gantt_data)
})

# Outcomes
output$outcome1_vb <- renderValueBox({
  valueBox("N/D", tr("reduction_rate"), icon = "fa-chart-line", color = "primary")
})

Tracking Indicators {.tabset}
=====================================

### `r textOutput("tracking_map1_title", inline = TRUE)`

```{r map-atendimentos}
output$tracking_map1_title <- renderText({ tr("section_tracking") })

output$map_atendimentos <- renderLeaflet({
  bairro_counts <- atendimentos %>% group_by(bairro) %>% summarise(total = n())
  set.seed(456)
  bairro_coords <- bairro_counts %>% 
    mutate(
      lat = -23.55 + runif(n(), -0.15, 0.15), 
      lon = -46.63 + runif(n(), -0.15, 0.15)
    )

  pal_bairros <- colorBin(palette = "viridis", domain = bairro_counts$total, bins = 5)
  sp_city_wgs84 <- st_transform(sp_city, crs = 4326)
  sp_center <- st_centroid(st_geometry(sp_city_wgs84)) %>% st_coordinates()

  leaflet(bairro_coords) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addCircles(
      lng = ~lon, lat = ~lat, weight = 1, radius = ~sqrt(total) * 1200, 
      color = ~pal_bairros(total), stroke = FALSE, fillOpacity = 0.7,
      popup = ~paste0("<b>", tr("map_neighborhood_popup_label"), ":</b> ", bairro, "<br><b>", tr("map_neighborhood_popup_visits"), ":</b> ", total)
    ) %>%
    addLegend(
      position = "bottomright", pal = pal_bairros, values = ~total,
      title = tr("map_neighborhood_legend_title"), opacity = 1
    ) %>%
    addMarkers(
      lng = -46.669943, lat = -23.556373, 
      popup = tr("map_hospital_label"), label = tr("map_hospital_label")
    ) %>%
    setView(lng = sp_center[1], lat = sp_center[2], zoom = 10)
})
leafletOutput("map_atendimentos")
```


### `r textOutput("tracking_map2_title", inline = TRUE)`

```{r map-renda}
output$tracking_map2_title <- renderText({ tr("map_income_title") })

output$map_renda <- renderLeaflet({
  sp_only_wgs84 <- st_transform(sp_only, crs = 4326)
  income_bins <- c(0, 500, 1000, 1500, 2000, 3000, 5000, 50000) 
  pal <- colorBin("viridis", domain = sp_only_wgs84$renda_per_capita, bins = income_bins, pretty = FALSE)
  sp_city_wgs84 <- st_transform(sp_city, crs = 4326)
  sp_center <- st_centroid(st_geometry(sp_city_wgs84)) %>% st_coordinates()

  leaflet(sp_only_wgs84) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addCircleMarkers(
      radius = 3, color = ~pal(renda_per_capita), stroke = FALSE, fillOpacity = 0.6,
      popup = ~paste("CEP:", POSTCODE, "<br>", tr("map_income_legend_title"), ": R$", renda_per_capita)
    ) %>%
    addLegend(
      position = "bottomright", pal = pal, values = ~renda_per_capita, 
      title = tr("map_income_legend_title"),
      labFormat = labelFormat(prefix = "R$ "), opacity = 1
    ) %>%
    addMarkers(
      lng = -46.669943, lat = -23.556373, 
      popup = tr("map_hospital_label"), label = tr("map_hospital_label")
    ) %>%
    setView(lng = sp_center[1], lat = sp_center[2], zoom = 9)
})
leafletOutput("map_renda")
```

