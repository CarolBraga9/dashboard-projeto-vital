---
title: "Dashboard do Projeto"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    theme: yeti
    iconLib: font-awesome
    encoding: UTF-8
runtime: shiny
---

```{r setup, include=FALSE}
# Instalação de pacotes
packages <- c("flexdashboard", "shiny", "shinyjs", "dplyr", "leaflet", "sf", "geobr", "htmlwidgets", "viridis", "timevis", "lubridate", "DT", "googlesheets4")

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg, repos = "https://cloud.r-project.org")
    library(pkg, character.only = TRUE)
  }
}

# Locale
try(Sys.setlocale("LC_ALL", "pt_BR.UTF-8"), silent = TRUE)

# Google Sheets
library(googlesheets4)
gs4_deauth()
url_planilha <- "https://docs.google.com/spreadsheets/d/1NUxmO-_XYut_3AwsdM9uMo9d9bFTHC47JYONnfbYsw8/edit?usp=sharing"

# Leitura dos dados
profissionais <- read_sheet(url_planilha, sheet = "treinamento")
atendimentos <- read_sheet(url_planilha, sheet = "atendimentos")
geo <- read_sheet(url_planilha, sheet = "geo")
translations_df <- read_sheet(url_planilha, sheet = "traducao")

# Processamento geográfico
crs_sirgas2000 <- 4674
geo <- geo %>% filter(!grepl("S", POSTCODE))
geo$geolocation_zip_code_prefix <- as.numeric(substr(geo$POSTCODE, 1, 5))
geo_sf <- st_as_sf(geo, coords = c("LON", "LAT"), crs = 4326)
sp_city <- read_municipality(code_muni = 3550308, year = 2020) %>% st_transform(crs = crs_sirgas2000)
geo_sf <- st_transform(geo_sf, crs = crs_sirgas2000)
sp_only <- geo_sf[st_within(geo_sf, sp_city, sparse = FALSE), ]

# Indicadores
num_treinados <- sum(profissionais$treinamento_realizado == "Sim", na.rm = TRUE)
nota_media <- mean(profissionais$nota_avaliacao, na.rm = TRUE)
total_atendidos <- n_distinct(atendimentos$id_pessoa)
total_atendimentos <- nrow(atendimentos)

# Tradução
to_list <- function(df) setNames(as.list(df[[2]]), df[[1]])
translations <- list(
  pt = setNames(as.list(translations_df$pt), translations_df$key),
  en = setNames(as.list(translations_df$en), translations_df$key)
)
current_lang <- reactiveVal("pt")
tr <- function(key) translations[[current_lang()]][[key]] %||% paste("Missing:", key)
```

<style>
.container-fluid { max-width: 98% !important; }
.lang-buttons { position: fixed; top: 10px; right: 20px; z-index: 1051; }
.lang-buttons .btn { padding: 4px 8px; font-size: 12px; }
</style>

<div class="logo-container">
  <a href="#"><img src="https://wiconnect.iadb.org/wp-content/uploads/2023/07/64ad685333e5720230711143355-1.png" alt="Logo" class="logo-left"></a>
</div>

```{r, echo=FALSE}
uiOutput("lang_buttons_ui")
```

<script>
Shiny.addCustomMessageHandler('setDocumentTitle', function(message) {
  document.title = message.title;
  $('.navbar-brand').text(message.title);
});
</script>

Página Inicial
=====================================

### `r textOutput("welcome_title", inline = TRUE)`

```{r}
output$welcome_title <- renderText({ tr("welcome_title") })
output$welcome_intro <- renderText({ tr("welcome_intro") })
```

Cronograma do Projeto
=====================================

```{r}
output$gantt_chart <- renderTimevis({
  gantt_data <- data.frame(
    id = 1:3,
    content = c("Planejamento", "Execução", "Encerramento"),
    start = as.Date(c("2025-01-01", "2025-05-26", "2025-12-26")),
    end = as.Date(c("2025-05-25", "2025-12-25", "2026-06-26")),
    className = c("completed", "not-started", "not-started")
  )
  timevis(gantt_data)
})

timevisOutput("gantt_chart", height = "800px")
```

Outcomes
=====================================

Column {.value-boxes}
-------------------------------------

```{r}
output$outcome1_vb <- renderValueBox({
  valueBox("N/D", "Redução na Taxa", icon = "fa-chart-line", color = "primary")
})
valueBoxOutput("outcome1_vb")
```

Tracking Indicators {.tabset}
=====================================

```{r}
output$map_atendimentos <- renderLeaflet({
  bairro_counts <- atendimentos %>% group_by(bairro) %>% summarise(total = n())
  bairro_coords <- bairro_counts %>% mutate(
    lat = -23.55 + runif(n(), -0.15, 0.15),
    lon = -46.63 + runif(n(), -0.15, 0.15)
  )
  pal <- colorBin("viridis", domain = bairro_counts$total, bins = 5)
  leaflet(bairro_coords) %>%
    addProviderTiles(providers$CartoDB.Positron) %>%
    addCircles(
      lng = ~lon, lat = ~lat, weight = 1, radius = ~sqrt(total) * 1200,
      color = ~pal(total), fillOpacity = 0.7
    )
})
leafletOutput("map_atendimentos")
```
